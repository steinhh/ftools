#!/usr/bin/env python3
"""
Create and push a tag based on the current project version.
Usage: ./tag-and-push [type] [N]
Where type is 'test' or 'prod' (defaults to 'test')
Where N is the number (auto-detected if not specified).
Creates tags like v6.0.19-test1, v6.0.19-prod1, etc.
"""

import re
import subprocess
import sys
import os


def get_current_version():
    """Extract version from setup.py"""
    setup_py_path = os.path.join(os.path.dirname(os.path.dirname(__file__)), 'setup.py')
    
    with open(setup_py_path, 'r') as f:
        content = f.read()
    
    # Look for version="X.Y.Z" pattern
    match = re.search(r'version\s*=\s*["\']([^"\']+)["\']', content)
    if not match:
        raise ValueError("Could not find version in setup.py")
    
    return match.group(1)


def get_existing_tags(version, tag_type):
    """Get existing tags for this version and type"""
    try:
        result = subprocess.run(['git', 'tag', '-l', f'v{version}-{tag_type}*'], 
                              capture_output=True, text=True, check=True)
        return result.stdout.strip().split('\n') if result.stdout.strip() else []
    except subprocess.CalledProcessError:
        return []


def get_next_number(version, tag_type):
    """Find the next available number for the given tag type"""
    existing_tags = get_existing_tags(version, tag_type)
    
    if not existing_tags:
        return 1
    
    # Extract numbers
    numbers = []
    for tag in existing_tags:
        match = re.search(rf'v{re.escape(version)}-{tag_type}(\d+)', tag)
        if match:
            numbers.append(int(match.group(1)))
    
    return max(numbers) + 1 if numbers else 1


def create_and_push_tag(version, tag_type, number):
    """Create and push the tag"""
    tag = f"v{version}-{tag_type}{number}"
    
    print(f"Creating tag: {tag}")
    
    try:
        # Create the tag
        subprocess.run(['git', 'tag', tag], check=True)
        print(f"? Created tag {tag}")
        
        # Push the tag
        subprocess.run(['git', 'push', 'origin', tag], check=True)
        print(f"? Pushed tag {tag} to origin")
        
        return tag
        
    except subprocess.CalledProcessError as e:
        print(f"Error: {e}")
        sys.exit(1)


def main():
    # Handle help request
    if len(sys.argv) > 1 and sys.argv[1] in ['--help', '-h', 'help']:
        print(__doc__)
        print("\nExamples:")
        print("  ./scripts/tag-and-push           # Auto: v6.0.19-test1")
        print("  ./scripts/tag-and-push test      # Auto: v6.0.19-test2") 
        print("  ./scripts/tag-and-push prod      # Auto: v6.0.19-prod1")
        print("  ./scripts/tag-and-push test 5    # Manual: v6.0.19-test5")
        print("  ./scripts/tag-and-push prod 3    # Manual: v6.0.19-prod3")
        return
    
    try:
        # Get current version from setup.py
        version = get_current_version()
        print(f"Current project version: {version}")
        
        # Parse arguments
        tag_type = 'test'  # default
        number = None
        
        if len(sys.argv) > 1:
            first_arg = sys.argv[1]
            if first_arg in ['test', 'prod']:
                tag_type = first_arg
                # Check for number as second argument
                if len(sys.argv) > 2:
                    try:
                        number = int(sys.argv[2])
                    except ValueError:
                        print("Error: Number must be an integer")
                        sys.exit(1)
            else:
                # First argument is a number, use default 'test' type
                try:
                    number = int(first_arg)
                except ValueError:
                    print(f"Error: Invalid argument '{first_arg}'. Use 'test', 'prod', or a number")
                    sys.exit(1)
        
        # Auto-detect number if not provided
        if number is None:
            number = get_next_number(version, tag_type)
            print(f"Auto-selected {tag_type} number: {number}")
        
        # Create and push tag
        tag = create_and_push_tag(version, tag_type, number)
        
        destination = "TestPyPI" if tag_type == 'test' else "PyPI"
        print(f"\n? Successfully created and pushed {tag}")
        print(f"This will trigger {destination} publishing via GitHub Actions.")
        
    except Exception as e:
        print(f"Error: {e}")
        sys.exit(1)


if __name__ == "__main__":
    main()